# $Id$

Set up DC with RNA sensor/DE

Set up and apply system policy with mfp set to generate id conflict events and the Nmap source set for a 1 hour timeout.

Set up RNA detection policy (wide open).

Set up nmap scan remediation

Set up and activate compliance rule/policy for OS conflict
	a host input event occurs + the OS or service identity for a host has a conflict
	5 minute snooze (for now)

Shut down dpress.  Boot up in OS 9; don't touch.

mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select inet_ntoa(ipaddr) as IP, port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'

(returns nothing)

Connect to dpress from Firman browser.

Should see RNA ident as OS 9.x (derived) in the host profile. 

root@glory:~# mysql -padmin sfsnort -e 'select current, fp_type, fp_source_type, fp_source_id, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select inet_ntoa(ipaddr) as IP, port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+----------------+--------------+-------------+------------+------------+------------+---------------------+
| current | fp_type | fp_source_type | fp_source_id | os_vendor   | os_product | os_version | confidence | time                |
+---------+---------+----------------+--------------+-------------+------------+------------+------------+---------------------+
|       0 |       1 |              0 |            0 | Apple, Inc. | Mac OS     | 9.0-9.2    |          0 | 2009-08-05 13:45:36 |
|       1 |       0 |              0 |            3 | Apple       | Mac OS     | 9.x        |         98 | 2009-08-05 13:45:36 |
+---------+---------+----------------+--------------+-------------+------------+------------+------------+---------------------+
+------------+------+----------+-------------+-----------+---------+------------+---------+---------+---------------------+
| IP         | port | protocol | source_type | source_id | current | service_id | vendor  | version | Last                |
+------------+------+----------+-------------+-----------+---------+------------+---------+---------+---------------------+
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       1 |          9 | MacHTTP | 2.6     | 2009-08-05 13:45:37 |
+------------+------+----------+-------------+-----------+---------+------------+---------+---------+---------------------+

Run manual NMAP scan of dpress.

Host profile should show the Operating System as HP-UX (that's an NMAP problem; Bug 51722 opened).  Click the View icaon, and the window should show both the RNA Mac OS 9.x ident and the NMAP ident.

root@glory:~# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select inet_ntoa(ipaddr) as IP, port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version | confidence | time                |
+---------+---------+-------------+------------+------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2    |          0 | 2009-08-04 15:32:28 |
|       0 |       0 | Apple       | Mac OS     | 9.x        |         98 | 2009-08-04 15:32:28 |
|       1 |       6 | HP          | HP-UX      | 11.X       |        100 | 2009-08-04 15:32:28 |
+---------+---------+-------------+------------+------------+------------+---------------------+
+------------+------+----------+-------------+-----------+---------+------------+---------------------------------+---------+---------------------+
| IP         | port | protocol | source_type | source_id | current | service_id | vendor                          | version | Last                |
+------------+------+----------+-------------+-----------+---------+------------+---------------------------------+---------+---------------------+
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | PersonalNetFinder               | 1.0     | 2009-08-04 15:31:20 |
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | MACOS_Personal_Websharing       |         | 2009-08-04 15:26:23 |
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | Web Sharing                     |         | 2009-08-04 15:31:20 |
| 10.4.12.75 |   80 | tcp      |           2 |         2 |       1 |          9 | Apple Personal Websharing httpd |         | 2009-08-04 15:32:29 |
| 10.4.12.75 |  548 | tcp      |           2 |         2 |       1 |    1000000 |                                 |         | 2009-08-04 15:32:29 |
+------------+------+----------+-------------+-----------+---------+------------+---------------------------------+---------+---------------------+

Now go to 10.4.12.75 and make an IE connection to Sato.

The backend should now show the client fingerprint as well:

root@glory:~# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select inet_ntoa(ipaddr) as IP, port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version | confidence | time                |
+---------+---------+-------------+------------+------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2    |          0 | 2009-08-04 15:32:28 |
|       1 |       6 | HP          | HP-UX      | 11.X       |        100 | 2009-08-04 15:32:28 |
|       0 |       0 | Apple       | Mac OS     | 9.x        |         98 | 2009-08-04 17:05:56 |
|       0 |       2 | Apple, Inc. | Mac OS     | 9.0-9.2    |          0 | 2009-08-04 17:05:56 |
+---------+---------+-------------+------------+------------+------------+---------------------+
+------------+------+----------+-------------+-----------+---------+------------+---------------------------------+---------+---------------------+
| IP         | port | protocol | source_type | source_id | current | service_id | vendor                          | version | Last                |
+------------+------+----------+-------------+-----------+---------+------------+---------------------------------+---------+---------------------+
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | PersonalNetFinder               | 1.0     | 2009-08-04 15:31:20 |
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | MACOS_Personal_Websharing       |         | 2009-08-04 15:26:23 |
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | Web Sharing                     |         | 2009-08-04 15:31:20 |
| 10.4.12.75 |   80 | tcp      |           2 |         2 |       1 |          9 | Apple Personal Websharing httpd |         | 2009-08-04 15:32:29 |
| 10.4.12.75 |  548 | tcp      |           2 |         2 |       1 |    1000000 |                                 |         | 2009-08-04 15:32:29 |
+------------+------+----------+-------------+-----------+---------+------------+---------------------------------+---------+---------------------+
root@glory:~# 

There should be no alert, no change in the GUI, and no conflict event, because there is no changed information even though a new fingerprint has been added. There should also be no change in the rna_service_info map.

Now reboot the box in to OS X.
Connect again from Firman.

root@glory:~# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select inet_ntoa(ipaddr) as IP, port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+---------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version    | confidence | time                |
+---------+---------+-------------+------------+---------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2       |          0 | 2009-08-04 15:32:28 |
|       0 |       2 | Apple, Inc. | Mac OS     | 9.0-9.2       |          0 | 2009-08-04 17:05:56 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4    |          0 | 2009-08-04 17:13:54 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2 |          0 | 2009-08-04 17:14:03 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.4.8-10.5   |          0 | 2009-08-04 17:14:16 |
|       0 |       0 | Apple       | Mac OS     | 9.x           |         41 | 2009-08-04 17:14:17 |
|       1 |       6 | Apple       | Mac OS X   | 10.3.X        |        100 | 2009-08-04 17:14:17 |
+---------+---------+-------------+------------+---------------+------------+---------------------+
+------------+------+----------+-------------+-----------+---------+------------+---------------------------+-----------------+---------------------+
| IP         | port | protocol | source_type | source_id | current | service_id | vendor                    | version         | Last                |
+------------+------+----------+-------------+-----------+---------+------------+---------------------------+-----------------+---------------------+
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | PersonalNetFinder         | 1.0             | 2009-08-04 15:31:20 |
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | MACOS_Personal_Websharing |                 | 2009-08-04 15:26:23 |
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | Web Sharing               |                 | 2009-08-04 15:31:20 |
| 10.4.12.75 |  427 | tcp      |           2 |         2 |       1 |    1000001 |                           |                 | 2009-08-04 17:14:18 |
| 10.4.12.75 |  548 | tcp      |           2 |         2 |       1 |    1000002 | Apple AFP                 |                 | 2009-08-04 17:14:18 |
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | Apache                    | 1.3.33 (Darwin) | 2009-08-04 17:13:54 |
| 10.4.12.75 |   80 | tcp      |           2 |         2 |       1 |          9 | Apache httpd              | 1.3.33          | 2009-08-04 17:14:18 |
| 10.4.12.75 | 5900 | tcp      |           0 |         0 |       0 |         24 |                           | 003.889         | 2009-08-04 17:14:10 |
| 10.4.12.75 |   22 | tcp      |           2 |         2 |       1 |         32 | OpenSSH                   | 4.5             | 2009-08-04 17:14:18 |
| 10.4.12.75 | 5900 | tcp      |           2 |         2 |       1 |         24 | Apple remote desktop vnc  |                 | 2009-08-04 17:14:18 |
+------------+------+----------+-------------+-----------+---------+------------+---------------------------+-----------------+---------------------+
root@glory:~# 

A conflict event should be generated and an NMAP scan started.

root@glory:~# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select inet_ntoa(ipaddr) as IP, port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+---------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version    | confidence | time                |
+---------+---------+-------------+------------+---------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2       |          0 | 2009-08-04 15:32:28 |
|       0 |       2 | Apple, Inc. | Mac OS     | 9.0-9.2       |          0 | 2009-08-04 17:05:56 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4    |          0 | 2009-08-04 17:13:54 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2 |          0 | 2009-08-04 17:14:03 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.4.8-10.5   |          0 | 2009-08-04 17:14:16 |
|       0 |       0 | Apple       | Mac OS     | 9.x           |         41 | 2009-08-04 17:14:17 |
|       1 |       6 | Apple       | Mac OS X   | 10.3.X        |        100 | 2009-08-04 17:14:17 |
+---------+---------+-------------+------------+---------------+------------+---------------------+
+------------+------+----------+-------------+-----------+---------+------------+---------------------------+-----------------+---------------------+
| IP         | port | protocol | source_type | source_id | current | service_id | vendor                    | version         | Last                |
+------------+------+----------+-------------+-----------+---------+------------+---------------------------+-----------------+---------------------+
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | PersonalNetFinder         | 1.0             | 2009-08-04 15:31:20 |
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | MACOS_Personal_Websharing |                 | 2009-08-04 15:26:23 |
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | Web Sharing               |                 | 2009-08-04 15:31:20 |
| 10.4.12.75 |  427 | tcp      |           2 |         2 |       1 |    1000001 |                           |                 | 2009-08-04 17:14:18 |
| 10.4.12.75 |  548 | tcp      |           2 |         2 |       1 |    1000002 | Apple AFP                 |                 | 2009-08-04 17:14:18 |
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | Apache                    | 1.3.33 (Darwin) | 2009-08-04 17:13:54 |
| 10.4.12.75 |   80 | tcp      |           2 |         2 |       1 |          9 | Apache httpd              | 1.3.33          | 2009-08-04 17:14:18 |
| 10.4.12.75 | 5900 | tcp      |           0 |         0 |       0 |         24 |                           | 003.889         | 2009-08-04 17:14:10 |
| 10.4.12.75 |   22 | tcp      |           2 |         2 |       1 |         32 | OpenSSH                   | 4.5             | 2009-08-04 17:14:18 |
| 10.4.12.75 | 5900 | tcp      |           2 |         2 |       1 |         24 | Apple remote desktop vnc  |                 | 2009-08-04 17:14:18 |
+------------+------+----------+-------------+-----------+---------+------------+---------------------------+-----------------+---------------------+
root@glory:~# 

Log in to the box and connect to Firman with Safari. The backend should show a new client fingerprint:


root@glory:~# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select inet_ntoa(ipaddr) as IP, port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+-------------------------------------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                                                        | confidence | time                |
+---------+---------+-------------+------------+-------------------------------------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2                                                           |          0 | 2009-08-04 15:32:28 |
|       0 |       2 | Apple, Inc. | Mac OS     | 9.0-9.2                                                           |          0 | 2009-08-04 17:05:56 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                                                        |          0 | 2009-08-04 17:13:54 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2                                                     |          0 | 2009-08-04 17:14:03 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.4.8-10.5                                                       |          0 | 2009-08-04 17:14:16 |
|       1 |       6 | Apple       | Mac OS X   | 10.3.X                                                            |        100 | 2009-08-04 17:14:17 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4                                                        |          0 | 2009-08-04 17:21:21 |
|       0 |       0 | Apple       | Mac OS X   | 10.4.8,  10.4.9,  10.4.10,  10.4.11, Server 10.4.8, Server 10.4.9 |         56 | 2009-08-04 17:21:21 |
+---------+---------+-------------+------------+-------------------------------------------------------------------+------------+---------------------+
+------------+------+----------+-------------+-----------+---------+------------+---------------------------+-----------------+---------------------+
| IP         | port | protocol | source_type | source_id | current | service_id | vendor                    | version         | Last                |
+------------+------+----------+-------------+-----------+---------+------------+---------------------------+-----------------+---------------------+
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | PersonalNetFinder         | 1.0             | 2009-08-04 15:31:20 |
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | MACOS_Personal_Websharing |                 | 2009-08-04 15:26:23 |
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | Web Sharing               |                 | 2009-08-04 15:31:20 |
| 10.4.12.75 |  427 | tcp      |           2 |         2 |       1 |    1000001 |                           |                 | 2009-08-04 17:14:18 |
| 10.4.12.75 |  548 | tcp      |           2 |         2 |       1 |    1000002 | Apple AFP                 |                 | 2009-08-04 17:14:18 |
| 10.4.12.75 |   80 | tcp      |           0 |         0 |       0 |          9 | Apache                    | 1.3.33 (Darwin) | 2009-08-04 17:13:54 |
| 10.4.12.75 |   80 | tcp      |           2 |         2 |       1 |          9 | Apache httpd              | 1.3.33          | 2009-08-04 17:14:18 |
| 10.4.12.75 | 5900 | tcp      |           0 |         0 |       0 |         24 |                           | 003.889         | 2009-08-04 17:14:10 |
| 10.4.12.75 |   22 | tcp      |           2 |         2 |       1 |         32 | OpenSSH                   | 4.5             | 2009-08-04 17:14:18 |
| 10.4.12.75 | 5900 | tcp      |           2 |         2 |       1 |         24 | Apple remote desktop vnc  |                 | 2009-08-04 17:14:18 |
+------------+------+----------+-------------+-----------+---------+------------+---------------------------+-----------------+---------------------+
root@glory:~# 

The GUI will still show the old RNA ident, but perhaps with a lower confidence.
 
After a period of time > the timeout period:

root@glory:~# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75" order by last_used;'
+---------+---------+-------------+------------+------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version             | confidence | time                |
+---------+---------+-------------+------------+------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2                |          0 | 2009-08-05 13:51:22 |
|       0 |       2 | Apple, Inc. | Mac OS     | 9.0-9.2                |          0 | 2009-08-05 13:55:35 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2          |          0 | 2009-08-05 13:58:33 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4             |          0 | 2009-08-05 13:58:33 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.1-10.2              |          0 | 2009-08-05 13:58:50 |
|       1 |       6 | Apple       | Mac OS X   | 10.3.X                 |        100 | 2009-08-05 13:58:51 |
|       0 |       0 | Apple       | Mac OS X   | 10.3,  10.3.1,  10.3.2 |         37 | 2009-08-05 13:58:51 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4             |          0 | 2009-08-05 14:02:55 |
+---------+---------+-------------+------------+------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+--------------------------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor                   | version         | Last                |
+------+----------+-------------+-----------+---------+------------+--------------------------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       0 |          9 | MacHTTP                  | 2.6             | 2009-08-05 13:49:44 |
|   80 | tcp      |           0 |         0 |       0 |          9 |                          |                 | 2009-08-05 13:49:50 |
|   80 | tcp      |           0 |         0 |       0 |          9 | Web Sharing              |                 | 2009-08-05 13:51:13 |
| 5900 | tcp      |           0 |         0 |       0 |         24 |                          | 003.889         | 2009-08-05 13:58:33 |
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache                   | 1.3.33 (Darwin) | 2009-08-05 13:58:39 |
|  427 | tcp      |           2 |         2 |       1 |    1000001 |                          |                 | 2009-08-05 13:58:51 |
|   22 | tcp      |           2 |         2 |       1 |         32 | OpenSSH                  | 4.5             | 2009-08-05 13:58:51 |
|   80 | tcp      |           2 |         2 |       1 |          9 | Apache httpd             | 1.3.33          | 2009-08-05 13:58:51 |
|  548 | tcp      |           2 |         2 |       1 |    1000002 | Apple AFP                |                 | 2009-08-05 13:58:51 |
| 5900 | tcp      |           2 |         2 |       1 |         24 | Apple remote desktop vnc |                 | 2009-08-05 13:58:51 |
+------+----------+-------------+-----------+---------+------------+--------------------------+-----------------+---------------------+
root@glory:~# 

And the host profile should reflect the updated derived fingerprint as the RNA fingerprint when viewing the OS.