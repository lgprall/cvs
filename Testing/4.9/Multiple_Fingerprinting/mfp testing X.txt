# $Id$

Set up DC with RNA sensor/DE

Set up a system policy with Multiple Fingerprinting set to generate id conflict events.  Make sure that Nmap and Nessus are number 1 and number 2 respectively in the list (they may be the only ones in the list). Set the Nmap timeout for 1 hour.  Apply the policy.

Set up and apply an RNA detection policy (wide open).

Set up nmap scan remediation

Set up and activate compliance rule/policy for OS conflict
	a host input event occurs + the OS or service identity for a host has a conflict
	5 minute snooze (for now)

Create a White List which includes the 10.4.12 network and does not allow OS 9.  Add that White List to the policy which you activated.

Shut down dpress.  Boot up in OS X; don't touch.

mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select inet_ntoa(ipaddr) as IP, port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'

(returns nothing)

Connect to dpress from Firefox on Firman.

Should see RNA ident as OS "10.3, 10.4, (etc)" (derived) in the host profile.  There should be one http service. There should be no "View" icon for the OS. Note the number of RNA vulnerabilities (598).

root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75" order by last_used;'
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                              | confidence | time                |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 19:29:01 |
|       1 |       0 | Apple       | Mac OS X   | 10.3,  10.4, Server 10.3.9, Server 10.4 |         98 | 2009-08-19 19:29:01 |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor | version         | Last                |
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       1 |          9 | Apache | 1.3.33 (Darwin) | 2009-08-19 19:29:02 |
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+


Copy the setosX.pl script (also attached) to the DC (/var/tmp is good)and run it:
-------------------------------
#!/usr/bin/perl 
 
use SF::SFDataCorrelator::HostInput; 
 
# Set the Source Type 
my $source_type = $SF::SFDataCorrelator::HostInput::SOURCE_TYPE_APP; 
 
# Obtain an Application ID 
my $source_id = SF::SFDataCorrelator::HostInput::GetSourceAppIDByName("FineGrain"); 
 
my $retval; 
 
# Set the operating system for Drill Press
if ($retval = SF::SFDataCorrelator::HostInput::SetOS(
	$source_type, $source_id, "10.4.12.75", [],
	{
		vendor_str => 'Apple, Inc',
		product_str => 'Mac OS X',
		version_str => '10.3.9',
		vendor_id => "174",
		product_id => "325",
		major => "10",
		minor => "3",
	}))
	{
		warn "SetOS failed with error $retval";
		exit;
	}	
--------------------------------

The backend should now show an application fingerprint (fp_type 7):

root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75" order by last_used;'
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                              | confidence | time                |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 19:29:01 |
|       1 |       7 | Apple, Inc  | Mac OS X   | 10.3.9                                  |        100 | 2009-08-19 19:31:27 |
|       0 |       0 | Apple       | Mac OS X   | 10.3,  10.4, Server 10.3.9, Server 10.4 |         98 | 2009-08-19 19:31:27 |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor | version         | Last                |
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       1 |          9 | Apache | 1.3.33 (Darwin) | 2009-08-19 19:29:02 |
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+

The GUI should show the application fingerprint, and a "View" icon should appear at the Operating System section. If you click the View icon, you should see both the application and the RNA identity. The number of RNA vulnerabilities should decrease (220) since the OS identification has been refined.

Now go to 10.4.12.75 and make a Safari connection to Sato.

The backend should now show the client fingerprint as well:

root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75" order by last_used;'
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                              | confidence | time                |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 19:29:01 |
|       1 |       7 | Apple, Inc  | Mac OS X   | 10.3.9                                  |        100 | 2009-08-19 19:31:27 |
|       0 |       0 | Apple       | Mac OS X   | 10.3,  10.4, Server 10.3.9, Server 10.4 |        100 | 2009-08-19 19:36:24 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 19:36:24 |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor | version         | Last                |
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       1 |          9 | Apache | 1.3.33 (Darwin) | 2009-08-19 19:29:02 |
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+
root@glory:/var/tmp# 

There should be no change in the GUI.

Now reboot the box in to OS 9.
Connect again from Firman.

root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75" order by last_used;'
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                              | confidence | time                |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 19:29:01 |
|       1 |       7 | Apple, Inc  | Mac OS X   | 10.3.9                                  |        100 | 2009-08-19 19:31:27 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 19:36:24 |
|       0 |       0 | Apple       | Mac OS X   | 10.3,  10.4, Server 10.3.9, Server 10.4 |         75 | 2009-08-19 19:45:25 |
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2                                 |          0 | 2009-08-19 19:45:25 |
|       1 |       8 | Apple       | Mac OS     | 9.x                                     |         25 | 2009-08-19 19:45:25 |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor  | version         | Last                |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache  | 1.3.33 (Darwin) | 2009-08-19 19:29:02 |
|   80 | tcp      |           0 |         0 |       1 |          9 | MacHTTP | 2.6             | 2009-08-19 19:45:29 |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+

A conflict event should be generated and an NMAP scan started.  Before the scan runs to completion, the backend will show a conflict (8) fingerprint for 9.x and the derived fingerprint will stay as 10.3 et cetera.  The GUI will show a conflict on the OS between the application fingerprint and the new 9.x RNA fingerprint.

root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75" order by last_used;'
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                              | confidence | time                |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 19:29:01 |
|       1 |       7 | Apple, Inc  | Mac OS X   | 10.3.9                                  |        100 | 2009-08-19 19:31:27 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 19:36:24 |
|       0 |       0 | Apple       | Mac OS X   | 10.3,  10.4, Server 10.3.9, Server 10.4 |         75 | 2009-08-19 19:45:25 |
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2                                 |          0 | 2009-08-19 19:45:25 |
|       1 |       8 | Apple       | Mac OS     | 9.x                                     |         25 | 2009-08-19 19:45:25 |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor  | version         | Last                |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache  | 1.3.33 (Darwin) | 2009-08-19 19:29:02 |
|   80 | tcp      |           0 |         0 |       1 |          9 | MacHTTP | 2.6             | 2009-08-19 19:45:29 |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+

When the scan completes, the scan (6) fingerprint will show HP-UX (NMAP bug):




root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75" order by last_used;'
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                              | confidence | time                |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 16:27:09 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 16:30:45 |
|       0 |       7 | Apple, Inc  | Mac OS X   | 10.3.9                                  |        100 | 2009-08-19 16:33:44 |
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2                                 |          0 | 2009-08-19 16:48:34 |
|       0 |       0 | Apple       | Mac OS X   | 10.3,  10.4, Server 10.3.9, Server 10.4 |         75 | 2009-08-19 16:50:25 |
|       1 |       6 | HP          | HP-UX      | 11.X                                    |        100 | 2009-08-19 16:50:25 |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+---------------------------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor                    | version         | Last                |
+------+----------+-------------+-----------+---------+------------+---------------------------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache                    | 1.3.33 (Darwin) | 2009-08-19 16:27:09 |
|   80 | tcp      |           0 |         0 |       0 |          9 | MacHTTP                   | 2.6             | 2009-08-19 16:48:46 |
|   80 | tcp      |           0 |         0 |       0 |          9 |                           |                 | 2009-08-19 16:48:52 |
|   80 | tcp      |           0 |         0 |       0 |          9 | Web Sharing               |                 | 2009-08-19 16:50:15 |
|   80 | tcp      |           2 |         2 |       0 |          9 |                           |                 | 2009-08-19 16:50:25 |
|  548 | tcp      |           2 |         2 |       1 |    1000002 |                           |                 | 2009-08-19 16:50:25 |
|   80 | tcp      |           0 |         0 |       0 |          9 | PersonalNetFinder         | 1.0             | 2009-08-19 16:51:22 |
|   80 | tcp      |           0 |         0 |       1 |          9 | MACOS_Personal_Websharing |                 | 2009-08-19 16:51:23 |
+------+----------+-------------+-----------+---------+------------+---------------------------+-----------------+---------------------+

After the scan, the GUI will show HP-UX as the active fingerprint (NMAP bug, fixed in later release but we're not likely to see it anytime soon.) Viewing the OS will eventually show the Nmap ident, the application ident and two RNA idents (one for 9.x, the other for 10.etc). There will be new http idents.

A White List violation for the operating system should be generated (but for HP-UX, not for OS 9 -- yet).

From the GUI, delete the bogus NMAP HP-UX identification.  There should now be a conflict between the application (10.3.9) and RNA (9.x) fingerprints.  Click the "Resolve" link to select the 9.x fingerprint.  The fingerprint source is now the user.  View the OS to show the user identity, the two RNA identities, and the application identity.

root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75" order by last_used;'
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                              | confidence | time                |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 19:29:01 |
|       0 |       7 | Apple, Inc  | Mac OS X   | 10.3.9                                  |        100 | 2009-08-19 19:31:27 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 19:36:24 |
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2                                 |          0 | 2009-08-19 19:45:25 |
|       0 |       2 | Apple, Inc. | Mac OS     | 9.0-9.2                                 |          0 | 2009-08-19 20:07:01 |
|       0 |       0 | Apple       | Mac OS     | 9.x                                     |         50 | 2009-08-19 20:13:37 |
|       0 |       0 | Apple       | Mac OS X   | 10.3,  10.4, Server 10.3.9, Server 10.4 |         50 | 2009-08-19 20:13:37 |
|       1 |       5 | Apple       | Mac OS     | 9.x                                     |        100 | 2009-08-19 20:13:37 |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor  | version         | Last                |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache  | 1.3.33 (Darwin) | 2009-08-19 19:29:02 |
|   80 | tcp      |           0 |         0 |       0 |          9 |         |                 | 2009-08-19 19:45:42 |
|   80 | tcp      |           2 |         2 |       0 |          9 |         |                 | 2009-08-19 19:46:50 |
|  548 | tcp      |           2 |         2 |       1 |    1000002 |         |                 | 2009-08-19 19:46:50 |
|   80 | tcp      |           0 |         0 |       0 |          9 | MacHTTP | 2.6             | 2009-08-19 20:07:47 |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+


Delete the Nmap (HPUX) ident from the GUI.
 
root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75" order by last_used;'
+---------+---------+-------------+------------+---------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version    | confidence | time                |
+---------+---------+-------------+------------+---------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4    |          0 | 2009-08-17 18:19:35 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.1-10.2     |          0 | 2009-08-17 18:24:38 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2 |          0 | 2009-08-17 18:24:39 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4    |          0 | 2009-08-17 18:57:33 |
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2       |          0 | 2009-08-17 20:34:04 |
|       0 |       2 | Apple, Inc. | Mac OS     | 9.0-9.2       |          0 | 2009-08-17 20:50:49 |
|       1 |       0 | Apple       | Mac OS     | 9.x           |         93 | 2009-08-17 20:58:14 |
+---------+---------+-------------+------------+---------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+---------------------------------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor                          | version         | Last                |
+------+----------+-------------+-----------+---------+------------+---------------------------------+-----------------+---------------------+
| 5900 | tcp      |           0 |         0 |       0 |         24 |                                 | 003.889         | 2009-08-17 18:45:47 |
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache                          | 1.3.33 (Darwin) | 2009-08-17 18:45:53 |
| 5900 | tcp      |           2 |         2 |       1 |         24 | Apple remote desktop vnc        |                 | 2009-08-17 18:46:05 |
|  427 | tcp      |           2 |         2 |       1 |    1000000 |                                 |                 | 2009-08-17 18:46:05 |
|   22 | tcp      |           2 |         2 |       1 |         32 | OpenSSH                         | 4.5             | 2009-08-17 18:46:05 |
|   80 | tcp      |           0 |         0 |       0 |          9 |                                 |                 | 2009-08-17 20:34:21 |
|   80 | tcp      |           0 |         0 |       0 |          9 | MacHTTP                         | 2.6             | 2009-08-17 20:34:29 |
|   80 | tcp      |           0 |         0 |       0 |          9 | Web Sharing                     |                 | 2009-08-17 20:34:29 |
|   80 | tcp      |           0 |         0 |       0 |          9 | PersonalNetFinder               | 1.0             | 2009-08-17 20:34:29 |
|  548 | tcp      |           2 |         2 |       1 |    1000002 | Apple AFP                       |                 | 2009-08-17 20:35:29 |
|   80 | tcp      |           2 |         2 |       1 |          9 | Apple Personal Websharing httpd | 1.3.33          | 2009-08-17 20:35:29 |
+------+----------+-------------+-----------+---------+------------+---------------------------------+-----------------+---------------------+
root@glory:/var/tmp# 

The host profile should reflect the updated derived fingerprint as the RNA fingerprint when viewing the OS

Run the setox9.pl script. Delete the user ident.  Number of vuls should go down.

Now reboot back to OS X.

Manually run an NMAP scan.
