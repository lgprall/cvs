# $Id: mfp_testingX.txt,v 1.1 2009/08/20 12:05:39 larry Exp $

Set up DC with RNA sensor/DE

Set up a system policy with Multiple Fingerprinting set to generate id conflict events.  Make sure that Nmap and Nessus are number 1 and number 2 respectively in the list (they may be the only ones in the list). Set the Nmap timeout for 1 hour.  Apply the policy.

Set up and apply an RNA detection policy (wide open).

Set up nmap scan remediation

Set up and activate compliance rule/policy for OS conflict
	a host input event occurs + the OS or service identity for a host has a conflict
	5 minute snooze (for now)

Create a White List which includes the 10.4.12 network and does not allow OS 9.  Add that White List to the policy which you activated.

Shut down dpress.  Boot up in OS X; don't touch.  Delete the 10.4.12.75 host from the network map.

mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'

(returns nothing)

Connect to dpress from Firefox on Firman.

root@glory:~# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                              | confidence | time                |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-20 18:19:16 |
|       1 |       0 | Apple       | Mac OS X   | 10.3,  10.4, Server 10.3.9, Server 10.4 |         98 | 2009-08-20 18:19:16 |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor | version         | Last                |
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       1 |          9 | Apache | 1.3.33 (Darwin) | 2009-08-20 18:19:17 |
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+


The fp_type 1 is a server fingerprint, and the type 0 is the derived fingerprint. In the GUI, should see RNA ident as OS "10.3, 10.4, (etc)" (derived) in the host profile.  There should be one http service. There should be no "View" icon for the OS. Note the number of RNA vulnerabilities (598).

Run a manual NMAP scan (can be done from a link on the profile page).

root@glory:~# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                                                                                        | confidence | time                |
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                                                                                        |          0 | 2009-08-20 18:19:16 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2                                                                                     |          0 | 2009-08-20 18:20:34 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.4.8-10.5                                                                                       |          0 | 2009-08-20 18:41:46 |
|       0 |       0 | Apple       | Mac OS X   | 10.4.8,  10.4.9,  10.4.10,  10.4.11, Server 10.4.8, Server 10.4.9, Server 10.4.10, Server 10.4.11 |         66 | 2009-08-20 18:41:50 |
|       1 |       6 | Apple       | Mac OS X   | 10.3.X                                                                                            |        100 | 2009-08-20 18:41:50 |
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+--------------------------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor                   | version         | Last                |
+------+----------+-------------+-----------+---------+------------+--------------------------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache                   | 1.3.33 (Darwin) | 2009-08-20 18:41:46 |
| 5900 | tcp      |           0 |         0 |       0 |         24 |                          | 003.889         | 2009-08-20 18:41:40 |
|   22 | tcp      |           2 |         2 |       1 |         32 | OpenSSH                  | 4.5             | 2009-08-20 18:41:50 |
|   80 | tcp      |           2 |         2 |       1 |          9 | Apache httpd             | 1.3.33          | 2009-08-20 18:41:50 |
|  427 | tcp      |           2 |         2 |       1 |    1000000 |                          |                 | 2009-08-20 18:41:50 |
|  548 | tcp      |           2 |         2 |       1 |    1000001 | Apple AFP                |                 | 2009-08-20 18:41:50 |
| 5900 | tcp      |           2 |         2 |       1 |         24 | Apple remote desktop vnc |                 | 2009-08-20 18:41:50 |
+------+----------+-------------+-----------+---------+------------+--------------------------+-----------------+---------------------+

Note that RNA has picked up a FreeBSD fingerprint as well as a (bogus) 10.4.8-10.5 fingerprint.  (The OS is actually 10.3.9.)

The GUI will now show a "View" icon in the Operating System section.  If you click that you will see both the NMAP and (expanded) RNA idents.  There will be several services other than http listed, and at least http will show both the NMAP and RNA ident when you click view.  The number of vulnerabilities will be less (341) because of a more refined OS identification, despite the additional services.

Now go to 10.4.12.75 and make a Safari connection to Sato.

The backend should now show the client fingerprint as well:

root@glory:~# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                                                                                        | confidence | time                |
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                                                                                        |          0 | 2009-08-20 18:19:16 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2                                                                                     |          0 | 2009-08-20 18:20:34 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.4.8-10.5                                                                                       |          0 | 2009-08-20 18:41:46 |
|       1 |       6 | Apple       | Mac OS X   | 10.3.X                                                                                            |        100 | 2009-08-20 18:41:50 |
|       0 |       0 | Apple       | Mac OS X   | 10.4.8,  10.4.9,  10.4.10,  10.4.11, Server 10.4.8, Server 10.4.9, Server 10.4.10, Server 10.4.11 |         80 | 2009-08-20 18:51:44 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4                                                                                        |          0 | 2009-08-20 18:51:44 |
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+--------------------------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor                   | version         | Last                |
+------+----------+-------------+-----------+---------+------------+--------------------------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache                   | 1.3.33 (Darwin) | 2009-08-20 18:41:46 |
| 5900 | tcp      |           0 |         0 |       0 |         24 |                          | 003.889         | 2009-08-20 18:41:40 |
|   22 | tcp      |           2 |         2 |       1 |         32 | OpenSSH                  | 4.5             | 2009-08-20 18:41:50 |
|   80 | tcp      |           2 |         2 |       1 |          9 | Apache httpd             | 1.3.33          | 2009-08-20 18:41:50 |
|  427 | tcp      |           2 |         2 |       1 |    1000000 |                          |                 | 2009-08-20 18:41:50 |
|  548 | tcp      |           2 |         2 |       1 |    1000001 | Apple AFP                |                 | 2009-08-20 18:41:50 |
| 5900 | tcp      |           2 |         2 |       1 |         24 | Apple remote desktop vnc |                 | 2009-08-20 18:41:50 |
+------+----------+-------------+-----------+---------+------------+--------------------------+-----------------+---------------------+

Now we have both a server and client RNA fingerprint for 10.3, 10.4, but the derived fingerprint ignores the 10.3 and takes the 10.4 because of the overlap. There should be no change in the GUI.

Copy the setosX.pl script (also attached) to the DC (/var/tmp is good)and run it:
-------------------------------
#!/usr/bin/perl 
 
use SF::SFDataCorrelator::HostInput; 
 
# Set the Source Type 
my $source_type = $SF::SFDataCorrelator::HostInput::SOURCE_TYPE_APP; 
 
# Obtain an Application ID 
my $source_id = SF::SFDataCorrelator::HostInput::GetSourceAppIDByName("FineGrain"); 
 
my $retval; 
 
# Set the operating system for Drill Press
if ($retval = SF::SFDataCorrelator::HostInput::SetOS(
	$source_type, $source_id, "10.4.12.75", [],
	{
		vendor_str => 'Apple, Inc',
		product_str => 'Mac OS X',
		version_str => '10.3.9',
		vendor_id => "174",
		product_id => "325",
		major => "10",
		minor => "3",
	}))
	{
		warn "SetOS failed with error $retval";
		exit;
	}	
--------------------------------

(The first time you run this, you may get a couple of dozen errors.  They are harmless and are a problem with the system, not the script, and it is not likely to be fixed anytime soon.)

The backend should now show an application fingerprint (fp_type 7):

root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                                                                                        | confidence | time                |
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                                                                                        |          0 | 2009-08-20 18:19:16 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2                                                                                     |          0 | 2009-08-20 18:20:34 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.4.8-10.5                                                                                       |          0 | 2009-08-20 18:41:46 |
|       1 |       6 | Apple       | Mac OS X   | 10.3.X                                                                                            |        100 | 2009-08-20 18:41:50 |
|       0 |       0 | Apple       | Mac OS X   | 10.4.8,  10.4.9,  10.4.10,  10.4.11, Server 10.4.8, Server 10.4.9, Server 10.4.10, Server 10.4.11 |         80 | 2009-08-20 18:51:44 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4                                                                                        |          0 | 2009-08-20 18:51:44 |
|       0 |       7 | Apple, Inc  | Mac OS X   | 10.3.9                                                                                            |        100 | 2009-08-20 19:02:18 |
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+--------------------------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor                   | version         | Last                |
+------+----------+-------------+-----------+---------+------------+--------------------------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache                   | 1.3.33 (Darwin) | 2009-08-20 18:41:46 |
| 5900 | tcp      |           0 |         0 |       0 |         24 |                          | 003.889         | 2009-08-20 18:41:40 |
|   22 | tcp      |           2 |         2 |       1 |         32 | OpenSSH                  | 4.5             | 2009-08-20 18:41:50 |
|   80 | tcp      |           2 |         2 |       1 |          9 | Apache httpd             | 1.3.33          | 2009-08-20 18:41:50 |
|  427 | tcp      |           2 |         2 |       1 |    1000000 |                          |                 | 2009-08-20 18:41:50 |
|  548 | tcp      |           2 |         2 |       1 |    1000001 | Apple AFP                |                 | 2009-08-20 18:41:50 |
| 5900 | tcp      |           2 |         2 |       1 |         24 | Apple remote desktop vnc |                 | 2009-08-20 18:41:50 |
+------+----------+-------------+-----------+---------+------------+--------------------------+-----------------+---------------------+

The GUI should still show the NMAP fingerprint since it ranks higher than the application in the System Policy. A "View" icon should appear at the Operating System section. If you click the View icon, you should see both the application and the RNA identity as well as the NMAP identity. There will be no change in the number of vulnerabilities since the active fingerprint (NMAP) has not changed.

Wait for the NMAP ident to time out after one hour (in this case from the time 2009-08-20 18:41:50).

root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                                                                                        | confidence | time                |
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                                                                                        |          0 | 2009-08-20 18:19:16 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2                                                                                     |          0 | 2009-08-20 18:20:34 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.4.8-10.5                                                                                       |          0 | 2009-08-20 18:41:46 |
|       0 |       0 | Apple       | Mac OS X   | 10.4.8,  10.4.9,  10.4.10,  10.4.11, Server 10.4.8, Server 10.4.9, Server 10.4.10, Server 10.4.11 |         80 | 2009-08-20 18:51:44 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4                                                                                        |          0 | 2009-08-20 18:51:44 |
|       1 |       7 | Apple, Inc  | Mac OS X   | 10.3.9                                                                                            |        100 | 2009-08-20 19:02:18 |
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor | version         | Last                |
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       1 |          9 | Apache | 1.3.33 (Darwin) | 2009-08-20 18:41:46 |
| 5900 | tcp      |           0 |         0 |       1 |         24 |        | 003.889         | 2009-08-20 18:41:40 |
+------+----------+-------------+-----------+---------+------------+--------+-----------------+---------------------+


The GUI will now show the application "FineGrain" ident for the OS, and if you click view you should see both the RNA and application idents.  The Nmap idents will no longer be seen in the services section, although the services reported by Nmap will still be there.


There are no other differences.

Now reboot the box in to OS 9 before the application ident times out.
Connect again from Firman.


A conflict event should be generated and an NMAP scan started.  Before the scan runs to completion, the backend will show a conflict (8) fingerprint for 9.x and the derived fingerprint will stay as 10.3 et cetera.  The GUI will show a conflict on the OS between the application fingerprint and the new 9.x RNA fingerprint. There will be a new MacHTTP http service.  When you view the http service you will see both RNA idents (MacHTTP and Apache).

root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                                                                                        | confidence | time                |
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                                                                                        |          0 | 2009-08-20 18:19:16 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2                                                                                     |          0 | 2009-08-20 18:20:34 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.4.8-10.5                                                                                       |          0 | 2009-08-20 18:41:46 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4                                                                                        |          0 | 2009-08-20 18:51:44 |
|       1 |       7 | Apple, Inc  | Mac OS X   | 10.3.9                                                                                            |        100 | 2009-08-20 19:02:18 |
|       0 |       0 | Apple       | Mac OS X   | 10.4.8,  10.4.9,  10.4.10,  10.4.11, Server 10.4.8, Server 10.4.9, Server 10.4.10, Server 10.4.11 |         26 | 2009-08-20 19:59:25 |
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2                                                                                           |          0 | 2009-08-20 19:59:25 |
|       1 |       8 | Apple       | Mac OS     | 9.x                                                                                               |         66 | 2009-08-20 19:59:25 |
+---------+---------+-------------+------------+---------------------------------------------------------------------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor  | version         | Last                |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache  | 1.3.33 (Darwin) | 2009-08-20 18:41:46 |
| 5900 | tcp      |           0 |         0 |       1 |         24 |         | 003.889         | 2009-08-20 18:41:40 |
|   80 | tcp      |           0 |         0 |       1 |          9 | MacHTTP | 2.6             | 2009-08-20 19:59:26 |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+

When the scan completes, the scan (6) fingerprint will show HP-UX (NMAP bug):

root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+---------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version    | confidence | time                |
+---------+---------+-------------+------------+---------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4    |          0 | 2009-08-20 18:19:16 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2 |          0 | 2009-08-20 18:20:34 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.4.8-10.5   |          0 | 2009-08-20 18:41:46 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4    |          0 | 2009-08-20 18:51:44 |
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2       |          0 | 2009-08-20 19:59:25 |
|       0 |       0 | Apple       | Mac OS     | 9.x           |         66 | 2009-08-20 20:00:51 |
|       1 |       6 | HP          | HP-UX      | 11.X          |        100 | 2009-08-20 20:00:51 |
+---------+---------+-------------+------------+---------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor  | version         | Last                |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache  | 1.3.33 (Darwin) | 2009-08-20 18:41:46 |
| 5900 | tcp      |           0 |         0 |       1 |         24 |         | 003.889         | 2009-08-20 18:41:40 |
|   80 | tcp      |           0 |         0 |       1 |          9 | MacHTTP | 2.6             | 2009-08-20 19:59:26 |
|   80 | tcp      |           2 |         2 |       0 |          9 |         |                 | 2009-08-20 20:00:51 |
|  548 | tcp      |           2 |         2 |       1 |    1000002 |         |                 | 2009-08-20 20:00:51 |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+


The GUI will show the conflict between OS 9 (RNA) and OS X (application) because FineGrain is still above Nmap in the system policy.  There will also be a service conflict between the RNA http ident (MacHTTP) and the Nmap ident which still shows Apache since the NMAP did not identify the OS 9 http server.

==============> A White List violation for the operating system should be generated (but for HP-UX, not for OS 9 -- yet).
Wait for the FineGrain identification to time out.

Now the conflict is resolved because the application ident is gone.  The active ident is now HP-UX and the vulnerabilities reflect that.

Run the setosX.pl script one more time (Yes, it's now in OS 9, but we're going to set it to OS X anyway.)

root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+---------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version    | confidence | time                |
+---------+---------+-------------+------------+---------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4    |          0 | 2009-08-20 18:19:16 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2 |          0 | 2009-08-20 18:20:34 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.4.8-10.5   |          0 | 2009-08-20 18:41:46 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4    |          0 | 2009-08-20 18:51:44 |
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2       |          0 | 2009-08-20 19:59:25 |
|       0 |       0 | Apple       | Mac OS     | 9.x           |         66 | 2009-08-20 20:00:51 |
|       1 |       6 | HP          | HP-UX      | 11.X          |        100 | 2009-08-20 20:00:51 |
|       0 |       7 | Apple, Inc  | Mac OS X   | 10.3.9        |        100 | 2009-08-20 20:13:46 |
+---------+---------+-------------+------------+---------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor  | version         | Last                |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache  | 1.3.33 (Darwin) | 2009-08-20 18:41:46 |
| 5900 | tcp      |           0 |         0 |       1 |         24 |         | 003.889         | 2009-08-20 18:41:40 |
|   80 | tcp      |           0 |         0 |       1 |          9 | MacHTTP | 2.6             | 2009-08-20 19:59:26 |
|   80 | tcp      |           2 |         2 |       0 |          9 |         |                 | 2009-08-20 20:00:51 |
|  548 | tcp      |           2 |         2 |       1 |    1000002 |         |                 | 2009-08-20 20:00:51 |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
root@glory:/var/tmp# 

And now run the setos9.pl script (again you'll get errors if it's the first time it's been run):
-------------------------------
#!/usr/bin/perl 
 
use SF::SFDataCorrelator::HostInput; 
 
# Set the Source Type 
my $source_type = $SF::SFDataCorrelator::HostInput::SOURCE_TYPE_APP; 
 
# Obtain an Application ID 
my $source_id = SF::SFDataCorrelator::HostInput::GetSourceAppIDByName("FineGrain"); 
 
my $retval; 
 
# Set the operating system for Drill Press
if ($retval = SF::SFDataCorrelator::HostInput::SetOS(
	$source_type, $source_id, "10.4.12.75", [],
	{
		vendor_str => 'Apple',
		product_str => 'Mac OS',
		version_str => '9.2.2',
		vendor_id => "174",
		product_id => "10002084",
		major => "9",
		minor => "2",
                revision => "2",
	}))
	{
		warn "SetOS failed with error $retval";
		exit;
	}	
-------------------------------
Now the old application ident will be replaced with the new one:

root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75";'
+---------+---------+-------------+------------+---------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version    | confidence | time                |
+---------+---------+-------------+------------+---------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4    |          0 | 2009-08-20 18:19:16 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2 |          0 | 2009-08-20 18:20:34 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.4.8-10.5   |          0 | 2009-08-20 18:41:46 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4    |          0 | 2009-08-20 18:51:44 |
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2       |          0 | 2009-08-20 19:59:25 |
|       0 |       0 | Apple       | Mac OS     | 9.x           |         66 | 2009-08-20 20:00:51 |
|       1 |       6 | HP          | HP-UX      | 11.X          |        100 | 2009-08-20 20:00:51 |
|       0 |       7 | Apple       | Mac OS     | 9.2.2         |        100 | 2009-08-20 20:18:14 |
+---------+---------+-------------+------------+---------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor  | version         | Last                |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache  | 1.3.33 (Darwin) | 2009-08-20 18:41:46 |
| 5900 | tcp      |           0 |         0 |       1 |         24 |         | 003.889         | 2009-08-20 18:41:40 |
|   80 | tcp      |           0 |         0 |       1 |          9 | MacHTTP | 2.6             | 2009-08-20 19:59:26 |
|   80 | tcp      |           2 |         2 |       0 |          9 |         |                 | 2009-08-20 20:00:51 |
|  548 | tcp      |           2 |         2 |       1 |    1000002 |         |                 | 2009-08-20 20:00:51 |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+


From the GUI delete the Nmap identification for the OS, and for HTTP (click the "View" icon on each to get there).


From the GUI, delete the bogus NMAP HP-UX identification.  There should now be a conflict between the application (10.3.9) and RNA (9.x) fingerprints.  Click the "Resolve" link to select the 9.x fingerprint.  The fingerprint source is now the user.  View the OS to show the user identity, the two RNA identities, and the application identity.

root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75" order by last_used;'
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version                              | confidence | time                |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 19:29:01 |
|       0 |       7 | Apple, Inc  | Mac OS X   | 10.3.9                                  |        100 | 2009-08-19 19:31:27 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4                              |          0 | 2009-08-19 19:36:24 |
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2                                 |          0 | 2009-08-19 19:45:25 |
|       0 |       2 | Apple, Inc. | Mac OS     | 9.0-9.2                                 |          0 | 2009-08-19 20:07:01 |
|       0 |       0 | Apple       | Mac OS     | 9.x                                     |         50 | 2009-08-19 20:13:37 |
|       0 |       0 | Apple       | Mac OS X   | 10.3,  10.4, Server 10.3.9, Server 10.4 |         50 | 2009-08-19 20:13:37 |
|       1 |       5 | Apple       | Mac OS     | 9.x                                     |        100 | 2009-08-19 20:13:37 |
+---------+---------+-------------+------------+-----------------------------------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor  | version         | Last                |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache  | 1.3.33 (Darwin) | 2009-08-19 19:29:02 |
|   80 | tcp      |           0 |         0 |       0 |          9 |         |                 | 2009-08-19 19:45:42 |
|   80 | tcp      |           2 |         2 |       0 |          9 |         |                 | 2009-08-19 19:46:50 |
|  548 | tcp      |           2 |         2 |       1 |    1000002 |         |                 | 2009-08-19 19:46:50 |
|   80 | tcp      |           0 |         0 |       0 |          9 | MacHTTP | 2.6             | 2009-08-19 20:07:47 |
+------+----------+-------------+-----------+---------+------------+---------+-----------------+---------------------+


Delete the Nmap (HPUX) ident from the GUI.
 
root@glory:/var/tmp# mysql -padmin sfsnort -e 'select current, fp_type, os_vendor, os_product, os_version, confidence, from_unixtime(last_seen) as time from rna_ip_os_map where ipaddr=inet_aton("10.4.12.75") order by last_seen;'; mysql -padmin sfsnort -e 'select port, protocol, source_type, source_id, current, service_id, vendor, version, from_unixtime(last_used) as Last from rna_service_info where inet_ntoa(ipaddr) = "10.4.12.75" order by last_used;'
+---------+---------+-------------+------------+---------------+------------+---------------------+
| current | fp_type | os_vendor   | os_product | os_version    | confidence | time                |
+---------+---------+-------------+------------+---------------+------------+---------------------+
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.3, 10.4    |          0 | 2009-08-17 18:19:35 |
|       0 |       1 | Apple, Inc. | Mac OS X   | 10.1-10.2     |          0 | 2009-08-17 18:24:38 |
|       0 |       1 | FreeBSD     | FreeBSD    | 5.0, 5.1, 5.2 |          0 | 2009-08-17 18:24:39 |
|       0 |       2 | Apple, Inc. | Mac OS X   | 10.3, 10.4    |          0 | 2009-08-17 18:57:33 |
|       0 |       1 | Apple, Inc. | Mac OS     | 9.0-9.2       |          0 | 2009-08-17 20:34:04 |
|       0 |       2 | Apple, Inc. | Mac OS     | 9.0-9.2       |          0 | 2009-08-17 20:50:49 |
|       1 |       0 | Apple       | Mac OS     | 9.x           |         93 | 2009-08-17 20:58:14 |
+---------+---------+-------------+------------+---------------+------------+---------------------+
+------+----------+-------------+-----------+---------+------------+---------------------------------+-----------------+---------------------+
| port | protocol | source_type | source_id | current | service_id | vendor                          | version         | Last                |
+------+----------+-------------+-----------+---------+------------+---------------------------------+-----------------+---------------------+
| 5900 | tcp      |           0 |         0 |       0 |         24 |                                 | 003.889         | 2009-08-17 18:45:47 |
|   80 | tcp      |           0 |         0 |       0 |          9 | Apache                          | 1.3.33 (Darwin) | 2009-08-17 18:45:53 |
| 5900 | tcp      |           2 |         2 |       1 |         24 | Apple remote desktop vnc        |                 | 2009-08-17 18:46:05 |
|  427 | tcp      |           2 |         2 |       1 |    1000000 |                                 |                 | 2009-08-17 18:46:05 |
|   22 | tcp      |           2 |         2 |       1 |         32 | OpenSSH                         | 4.5             | 2009-08-17 18:46:05 |
|   80 | tcp      |           0 |         0 |       0 |          9 |                                 |                 | 2009-08-17 20:34:21 |
|   80 | tcp      |           0 |         0 |       0 |          9 | MacHTTP                         | 2.6             | 2009-08-17 20:34:29 |
|   80 | tcp      |           0 |         0 |       0 |          9 | Web Sharing                     |                 | 2009-08-17 20:34:29 |
|   80 | tcp      |           0 |         0 |       0 |          9 | PersonalNetFinder               | 1.0             | 2009-08-17 20:34:29 |
|  548 | tcp      |           2 |         2 |       1 |    1000002 | Apple AFP                       |                 | 2009-08-17 20:35:29 |
|   80 | tcp      |           2 |         2 |       1 |          9 | Apple Personal Websharing httpd | 1.3.33          | 2009-08-17 20:35:29 |
+------+----------+-------------+-----------+---------+------------+---------------------------------+-----------------+---------------------+
root@glory:/var/tmp# 

The host profile should reflect the updated derived fingerprint as the RNA fingerprint when viewing the OS

Run the setox9.pl script. Delete the user ident.  Number of vuls should go down.

Now reboot back to OS X.

Manually run an NMAP scan.
